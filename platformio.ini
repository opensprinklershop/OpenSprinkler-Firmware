; PlatformIO Project Configuration File
;
;   Build options: build flags, source filter
;   Upload options: custom upload port, speed and extra flags
;   Library options: dependencies, extra library storages
;   Advanced options: extra scripting
;
; Please visit documentation for the other options and examples
; https://docs.platformio.org/page/projectconf.html

[platformio]
src_dir = .
include_dir = .
build_cache_dir = .pio/cache

[env:esp32-c5]
# to get it running: 
# 1. You need a OpenSprinkler with ESP32-C5-WROOM-1-N8R8 and W25Q128 external flash
# 2. Edit pins_arduino.h: 
#static const uint8_t TX = 11;
#static const uint8_t RX = 12;
#static const uint8_t SDA = 0;
#static const uint8_t SCL = 1;
#static const uint8_t SS = 5;
#static const uint8_t MOSI = 13;
#static const uint8_t MISO = 14;
#static const uint8_t SCK = 6;
# See: https://community.platformio.org/t/esp32c6-arduino-3-00-and-zigbee-support/40094/18
platform = file://../platform-espressif32
platform_packages = 
	framework-espidf @ file://../esp-idf
framework = arduino
board = os4proEsp32
board_build.mcu = esp32c5
board_build.flash_mode = qio
board_build.psram_type = qio
board_build.filesystem = littlefs
board_build.partitions = os4_matter.csv
board_build.sdkconfig = sdkconfig.esp32-c5
upload_protocol = esptool
monitor_filters = esp32_exception_decoder
upload_speed = 460800
#upload_protocol = espota
#upload_port = 192.168.4.1          # Adjust to your ESP32 IP address
#upload_flags = 
#    --auth=opendoor                  # Password must match OpenSprinkler password
monitor_speed = 115200
build_type = debug
build_flags = 
	-D BOARD_HAS_PSRAM
	-D ESP32C5
	#-D OS_ENABLE_ZIGBEE 
	-D OS_ENABLE_BLE
	-D ENABLE_MATTER
	-D ENABLE_DEBUG
	-D ENABLE_MEMORY_DEBUG
	-D OTF_USE_PSRAM=1
	-D OTF_USE_PSRAM_FOR_SSL=1
	-D OTF_ENABLE_PSRAM_POOL=1
	-D MBEDTLS_SSL_PROTO_TLS1_3
	-D CONFIG_MBEDTLS_SSL_PROTO_TLS1_3=1
	-D CORE_DEBUG_LEVEL=0
	-D CHIP_CONFIG_MEMORY_MANAGEMENT_SMALL_BUFFER_POOL=1
	-D CHIP_CONFIG_MEMORY_MANAGEMENT_MALLOC_LIMIT=80000
	-D CHIP_SYSTEM_CONFIG_PACKETBUFFER_POOL_SIZE=8
	-D CHIP_CONFIG_MAX_EXCHANGE_CONTEXTS=4
	-D CHIP_CONFIG_MAX_BINDINGS=3
	-D CHIP_CONFIG_MAX_FABRICS=3
	-D CHIP_CONFIG_MAX_PATHS_PER_INVOKE=3
	-D CHIP_IM_MAX_NUM_COMMAND_HANDLER=2
	-D CHIP_IM_MAX_NUM_WRITE_HANDLER=2
	#-D SERIAL_DEBUG
	#-D ZIGBEE_MODE_ZCZR	
	-I..\OpenThings-Framework-Firmware-Library
	-ffunction-sections
	-fdata-sections
	-fno-exceptions
	-fno-rtti
	-flto
	-Os
	-Wl,--gc-sections
	-Wl,-Map,.pio/build/esp32-c5/firmware.map
	-Wl,--cref
	-Wl,--print-memory-usage
build_unflags = 
	-fno-lto
extra_scripts = 
	fix_linker.py
	remove_helix_mp3.py
lib_ignore =
   Zigbee
   SD
   SPIFFS
   FFat
lib_deps = 
	Ethernet
	Matter
	#Zigbee
	https://github.com/ThingPulse/esp8266-oled-ssd1306/archive/4.2.0.zip
	knolleary/PubSubClient @ ^2.8
	https://github.com/OpenSprinklerShop/ArduinoWebSockets
	#https://github.com/OpenSprinklerShop/OpenThings-Framework-Firmware-Library
	symlink://../OpenThings-Framework-Firmware-Library
	RobTillaart/ADS1X15
	https://github.com/tobiasschuerg/InfluxDB-Client-for-Arduino
build_src_filter = +<*> -<*.ino> -<html/*> -<external/*> -<ospi-analog/*> -<sensor_ospi*> -<managed_components/*>

[env:os3x_esp8266]
platform = espressif8266@4.2.1
board = d1_mini
framework = arduino
lib_ldf_mode = deep
lib_deps = 
	https://github.com/ThingPulse/esp8266-oled-ssd1306
	knolleary/PubSubClient
	https://github.com/OpenSprinklerShop/OpenThings-Framework-Firmware-Library
	https://github.com/OpenSprinklerShop/ArduinoWebSockets
	RobTillaart/ADS1X15
	https://github.com/bluemurder/esp8266-ping
	https://github.com/tobiasschuerg/InfluxDB-Client-for-Arduino
build_src_filter = +<*> -<html/*> --<external/*>
upload_speed = 460800
monitor_speed = 115200
board_build.flash_mode = dio
board_build.ldscript = eagle.flash.4m2m.ld
board_build.f_cpu = 160000000L
board_build.f_flash = 80000000L
#build_flags = -DARP_TABLE_SIZE=40
build_type = debug
build_flags = 
	-DENABLE_DEBUG 
    -Os
    -ffunction-sections
    -fdata-sections
    -Wl,--gc-sections
monitor_filters = colorize, esp8266_exception_decoder
;ESP8266;ARDUINO;DEBUG_ESP_SSL;DEBUG_ESP_PORT)

[env:linux]
platform = native
build_flags = 
	-DOSPI
	-lpthread
	-lmosquitto
	-lssl
	-lcrypto
	-std=c++14
	-Iexternal/influxdb-cpp
lib_deps = 
	https://github.com/ThingPulse/esp8266-oled-ssd1306
	https://github.com/opensprinklershop/OpenThings-Framework-Firmware-Library
	https://github.com/orca-zhang/influxdb-cpp.git
; NOTE: This environment requires Linux or WSL to build.
; On Windows, use WSL: cd /mnt/d/Projekte/openSprinkler-firmware-esp32 && pio run -e linux
; Or use the build.sh script in WSL

[env:demo]
platform = native
build_flags = 
	-DDEMO
	-DDISABLE_INFLUXDB
	-std=c++14

; The demo environment is a minimal native (Windows-friendly) compile/link sanity-check.
; Full native OSPI (Linux/WSL) builds should use `env:linux`.
build_src_filter = -<*> +<demo_build.cpp>
; NOTE: For full native OSPI (Linux/WSL) builds use `env:linux`.
